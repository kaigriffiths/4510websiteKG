import pandas as pd
import matplotlib.pyplot as plt
import os

# Load dataset
df = pd.read_excel("data/Grad Program Exit Survey Data 2024.xlsx")

# Remove metadata rows
df_clean = df.iloc[2:].copy()

# Identify rating columns
likert_cols = [col for col in df_clean.columns if col.startswith("Q58_")]

# Extract readable names
course_names = df.iloc[0][likert_cols].values

# Map Likert scale
likert_map = {
    "Strongly Disagree": 1,
    "Disagree": 2,
    "Neither disagree or agree": 3,
    "Agree": 4,
    "Strongly Agree": 5
}

ratings = df_clean[likert_cols].replace(likert_map)
ratings = ratings.apply(pd.to_numeric, errors='coerce')

# Compute averages
mean_ratings = ratings.mean().reset_index()
mean_ratings.columns = ["Course_Column", "Average_Rating"]
mean_ratings["Course_Name"] = course_names
mean_ratings = mean_ratings.sort_values(
    by="Average_Rating",
    ascending=False
).reset_index(drop=True)

mean_ratings["Rank"] = mean_ratings.index + 1

# Save outputs
os.makedirs("output", exist_ok=True)
mean_ratings.to_csv("output/course_ranking_2024.csv", index=False)

plt.figure()
plt.barh(mean_ratings["Course_Name"], mean_ratings["Average_Rating"])
plt.gca().invert_yaxis()
plt.xlabel("Average Rating")
plt.ylabel("Course")
plt.title("2024 Course Rankings Based on Student Ratings")
plt.savefig("output/course_ranking_2024.png")
plt.close()
